<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
	<title>Ti Game</title>
<style type="text/css">
@font-face {
	font-family: "Pixel";
	src: url("Pixel.ttf");
}
*{padding:0; margin:0; font-family: Pixel, sans-serif;}
body{background-color: #7A3880;
	height:100vh; width: 100vw;
	overflow: hidden;
	transition:0.5s;
}
canvas{
    image-rendering: optimizeSpeed;
    image-rendering: -moz-crisp-edges;
    image-rendering: -webkit-optimize-contrast;
    image-rendering: optimize-contrast;
    image-rendering: pixelated;
    -ms-interpolation-mode: nearest-neighbor;
}
canvas#game{
	position: fixed;
	top:50vh; left:50vw;
	transform: translate(-50%,-50%);
	width: auto; height: auto;
	max-width: 90vw; max-height:90vh;
	border: 7px solid #eee;
    background-color: #423420;
}

</style>
</head>
<body id="body" style="">
	<canvas id='game' width='400' height='640'>
		Canvas n'est pas compatible avec votre navigateur...
	</canvas>
	
<script type="text/javascript">

var canvas = document.getElementById("game");
var ctx = canvas.getContext("2d");
var body = document.getElementById('body');

/* Canvas Onclick position */
function getMousePos(canvas, evt) {
    var rect = canvas.getBoundingClientRect();
    return {
      x: (evt.clientX - rect.left)/canvas.offsetWidth,
      y: (evt.clientY - rect.top)/canvas.offsetHeight
    };
}
canvas.addEventListener('click', function(evt) {
    game_Event(getMousePos(canvas, evt));
}, false);

/* Images loading */
var nbImgLoaded = 0, nbImg = 5;

var background_Img = new Image();
var dog_Img = new Image();
var color_Img = new Image();
var goDog_Img = new Image();
var rerun_Img = new Image();

background_Img.onload = () => imgIsLoaded();
dog_Img.onload = () => imgIsLoaded();
color_Img.onload = () => imgIsLoaded();
goDog_Img.onload = () => imgIsLoaded();
rerun_Img.onload = () => imgIsLoaded();

background_Img.src = 'Img/Background.png'; // https://qmisslin.github.io/Ti_Game/
dog_Img.src = 'Img/Dog.png';
color_Img.src = 'Img/Color.png';
goDog_Img.src = 'Img/GameOver_Dog.png';
rerun_Img.src = "Img/Rerun.png";

function imgIsLoaded(){
	nbImgLoaded++;
	if(nbImgLoaded == nbImg){
		window.setTimeout(function (){
			game_Loop();
		}, 500);
	}
}

/* Game */
var game_Frame = 0;
var game_Speed = 100;
var game_Freeze = false;

var background_Frame = 0;
var background_Speed = 25;

var dog_Frame = 0;
var dog_Speed = 5;
var dog_Pos = {x:-165, y:0, d:1};


var color_Frame = 0;
var color_Speed = 100;
var color_Value = 0;

var gameOver_Frame = 0;
var gameOver_Speed = 5;
var gameOver_Active = false;

var gameOverError_frame = 0;
var gameOverError_Speed = 5;
var gameOverError_Active = false;
var gameOverError_Msg = "";


var timerRange_Max = 200;
var timerRange = timerRange_Max;
var timerOk = true;

var score = 0;

function randomInt(min, max){
	return Math.floor(Math.random()*(max-min))+min;
}
function game_Loop(){
	window.setTimeout(function (){
		
		/* Background animation */
		if(game_Frame%background_Speed === 0){
			background_Frame=(background_Frame+1)%2;
		}
		if(!game_Freeze){
			/* Dog animation */
			if(game_Frame%dog_Speed === 0){
				dog_Frame = (dog_Frame+1)%8;
				dog_Pos.x += -(dog_Pos.d*2-1)*15;
			}
			if(dog_Pos.x < -160 || dog_Pos.x > 400){
				
				dog_Pos.d = (dog_Pos.d === 0)?1:0;
				if(dog_Pos.d === 0){
					dog_Pos.x = -160;
					dog_Pos.y = randomInt(140,445);//140~445
				} else {
					dog_Pos.x = 400;
					dog_Pos.y = randomInt(185,445);//185~445
				}
			}
		}
		
		/* Game over animation */
		if(gameOver_Active && game_Frame%gameOver_Speed === 0){
			if(gameOver_Frame < 6){
				gameOver_Frame++;
			} else {
				gameOverError_Msg = 
					"Ho non ! Le chien\ns'est echappe\npar un trou\ndans la barriere\nau fond du\njardin !";
				game_Over();
				return;
			}
		}
			


		/* Color print animation */
		if(timerOk){
			color_Value = randomInt(0,16);
			timerOk = false;
			timerRange = timerRange_Max;
		}

		/* Dog animation game over */
		if(!gameOver_Active && dog_Pos.x > 150 && dog_Pos.y < 185){
			gameOver_Active = true;
			gameOver_Frame = 0;
			game_Freeze = true;
		}

		/* Timer testing */
		if(timerRange === 0){
			gameOverError_Msg = "Oups,\ntu as mis trop de \ntemps a repondre !";
		} else {
			timerRange--;
		}

		if(gameOverError_Msg !== ""){
			game_Over();
			return;
		}

		ctx.drawImage(background_Img, 400 * background_Frame, 0, 400, 640, 0, 0, 400, 640);
		ctx.drawImage(dog_Img, dog_Pos.d * 160,160 * dog_Frame, 160, 160, dog_Pos.x, dog_Pos.y, 160, 160);
		ctx.clearRect(15,15,240,55);
		
		/* Timer range */
		ctx.fillStyle="rgb("+
				Math.floor(255*(1-timerRange/timerRange_Max))+","+
				Math.floor(255*(  timerRange/timerRange_Max))+",20)";
		ctx.fillRect(15,65,(240*(timerRange/timerRange_Max)),5);
		ctx.drawImage(color_Img, 240 * (color_Value%4), 50 * Math.floor(color_Value/4),240,50,15,15,240,50);

		/* Game Over Sprite */
		if(gameOver_Active && gameOver_Frame < 7){
			ctx.drawImage(goDog_Img, 0, gameOver_Frame*640, 400, 640, 0, 0, 400, 640);
		}

		/* Score text  */
		printMsg(5, 555, 40, "SCORE : "+score, "#423420");
		window.requestAnimationFrame(game_Loop);
		

		/* Increment game frame */
		game_Frame = (game_Frame+1)%game_Speed;
	}, 10);
}

function game_Event(mouse){
	console.log(mouse);
	
	var modulusValue = -1;
	if(mouse.y > 0.87){
		if(mouse.x < 0.18){ // Yellow button
			body.style.backgroundColor = "#806A24";
			modulusValue = 0;

		} else if(mouse.x < 0.36){ // Blue button
			body.style.backgroundColor = "#243580";
			modulusValue = 1;

		} else if(mouse.x < 0.53){ // Green button 
			body.style.backgroundColor = "#278024";
			modulusValue = 2;

		} else if(mouse.x < 0.70){ // Pink button
			body.style.backgroundColor = "#7A3880";
			modulusValue = 3;

		} else { // Red button 
			body.style.backgroundColor = "#802222";
			dog_Pos.d = (dog_Pos.d === 0)?1:0;
		}
	}

	if(modulusValue !== -1){
		if(Math.floor(color_Value/4) === modulusValue){
			timerOk = true;
			score++;
		} else {
			gameOverError_Msg = "Oups,\nmauvaise couleur !"
		}
	}
}

function printMsg(x, y, size, msg, color){
	var lines = msg.split('\n');
	var lineheight = size;

	ctx.font = size+"px Pixel";
	ctx.fillStyle = color;
	for (var i = 0; i<lines.length; i++)
    	ctx.fillText(lines[i], x, y + (i*lineheight) );
}

function game_Over(){
	ctx.drawImage(rerun_Img, 0,100);
	printMsg(25, 200, 32, gameOverError_Msg, "#eee");

}

</script>
</body>
</html>