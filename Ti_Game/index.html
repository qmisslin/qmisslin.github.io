<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
	<title>Ti Game</title>
<style type="text/css">
*{padding:0; margin:0;}
body{background-color: #7A3880;
	height:100vh; width: 100vw;
	overflow: hidden;
	transition:0.5s;
}
canvas{
    image-rendering: optimizeSpeed;
    image-rendering: -moz-crisp-edges;
    image-rendering: -webkit-optimize-contrast;
    image-rendering: optimize-contrast;
    image-rendering: pixelated;
    -ms-interpolation-mode: nearest-neighbor;
}
canvas#game {
	position: fixed;
	top:50vh; left:50vw;
	transform: translate(-50%,-50%);
	width: auto; height: auto;
	max-width: 90vw; max-height:90vh;
	border: 7px solid #eee;
    background-image:url("Img/Loader.png");
    background-repeat: no-repeat;
    background-position: 50% 50%;
    background-size: 90% auto;
    background-color: #423420;
}

</style>
</head>
<body id="body" style="">
	<p id="test">Coucou</p>
	<canvas id='game' width='400' height='640'>
		Canvas n'est pas compatible avec votre navigateur...
	</canvas>
<script type="text/javascript">

var canvas = document.getElementById("game");
var ctx = canvas.getContext("2d");
var body = document.getElementById('body');

/* Canvas Onclick position */
function getMousePos(canvas, evt) {
    var rect = canvas.getBoundingClientRect();
    return {
      x: (evt.clientX - rect.left)/canvas.offsetWidth,
      y: (evt.clientY - rect.top)/canvas.offsetHeight
    };
}
canvas.addEventListener('click', function(evt) {
    game_Event(getMousePos(canvas, evt));
}, false);



/* Images loading */
var nbImgLoaded = 0, nbImg = 4;

var background_Img = new Image();
var dog_Img = new Image();
var color_Img = new Image();
var goDog_Img = new Image();

background_Img.onload = () => imgIsLoaded();
dog_Img.onload = () => imgIsLoaded();
color_Img.onload = () => imgIsLoaded();
goDog_Img.onload = () => imgIsLoaded();

background_Img.src = 'Img/Background.png'; // https://qmisslin.github.io/Ti_Game/
dog_Img.src = 'Img/Dog.png';
color_Img.src = 'Img/Color.png';
goDog_Img.src = 'Img/GameOver_Dog.png';

function imgIsLoaded(){
	nbImgLoaded++;
	if(nbImgLoaded == nbImg){
		window.setTimeout(function (){ game_Loop()}, 1000);
	}
}

/* Game */
var game_Frame = 0;
var game_Speed = 100;
var game_Freeze = false;

var background_Frame = 0;
var background_Speed = 25;

var dog_Frame = 0;
var dog_Speed = 5;
var dog_Pos = {x:-165, y:0, d:1};


var color_Frame = 0;
var color_Speed = 100;
var color_Value = 0;

var gameOver_Frame = 0;
var gameOver_Speed = 5;
var gameOver_Active = false;

var gameOverError_frame = 0;
var gameOverError_Speed = 5;
var gameOverError_Active = false;

var timerRange = game_Speed;
var timerRange_Speed = 0; 

function randomInt(min, max){
	return Math.floor(Math.random()*(max-min))+min;
}
function game_Loop(){
	window.setTimeout(function (){
		
		/* Background animation */
		if(game_Frame%background_Speed === 0){
			background_Frame=(background_Frame+1)%2;
		}
		if(!game_Freeze){
			/* Dog animation */
			if(game_Frame%dog_Speed === 0){
				dog_Frame = (dog_Frame+1)%8;
				dog_Pos.x += -(dog_Pos.d*2-1)*15;
			}
			if(dog_Pos.x < -160 || dog_Pos.x > 400){
				
				dog_Pos.d = (dog_Pos.d === 0)?1:0;
				if(dog_Pos.d === 0){
					dog_Pos.x = -160;
					dog_Pos.y = randomInt(140,445);//140~445
				} else {
					dog_Pos.x = 400;
					dog_Pos.y = randomInt(185,445);//185~445
				}
			}
		}
		
		/* Game over animation */
		if(gameOver_Active && game_Frame%gameOver_Speed === 0){
			if(gameOver_Frame < 6){
				gameOver_Frame++;
			} else {
				game_Over();
				return;
			}
		}
			


		/* Color print animation */
		if(game_Frame%color_Speed === 0){
			color_Value = randomInt(0,16);
		}

		if(!gameOver_Active && dog_Pos.x > 150 && dog_Pos.y < 185){
			console.log("game over animation start");
			gameOver_Active = true;
			gameOver_Frame = 0;
			game_Freeze = true;
		}

		if(timerRange === timerRange_Speed){
			console.log("Timer out !")
			return;
		} else {
			timerRange++;
		}

		ctx.drawImage(background_Img, 400 * background_Frame, 0, 400, 640, 0, 0, 400, 640);
		ctx.drawImage(dog_Img, dog_Pos.d * 160,160 * dog_Frame, 160, 160, dog_Pos.x, dog_Pos.y, 160, 160);
		ctx.clearRect(15,15,240,55);
		
		/* Timer range */
		ctx.fillStyle="rgb("+(255*timerRange/timerRange_Speed)+","+(255-255*(timerRange/timerRange_Speed))+",20)";
		ctx.fillRect(15,65,240-(240*timerRange/timerRange_Speed),5);
		ctx.drawImage(color_Img, 240 * (color_Value%4), 50 * Math.floor(color_Value/4),240,50,15,15,240,50);

		/* Game Over Sprite */
		if(gameOver_Active && gameOver_Frame < 7){
			ctx.drawImage(goDog_Img, 0, gameOver_Frame*640, 400, 640, 0, 0, 400, 640);
		}

		window.requestAnimationFrame(game_Loop);
		

		/* Increment game frame */
		game_Frame = (game_Frame+1)%game_Speed;
	}, 10);
}

function game_Event(mouse){
	console.log(mouse);
	
	var str = "Mouse2("+mouse.x+","+mouse.y+")<br>";
	if(mouse.y > 0.87){
		if(mouse.x < 0.18){ // Yellow button
			str+="yellow";
			body.style.backgroundColor = "#806A24";

		} else if(mouse.x < 0.36){ // Blue button
			str+="blue";
			body.style.backgroundColor = "#243580";

		} else if(mouse.x < 0.53){ // Green button 
			str+="green";
			body.style.backgroundColor = "#278024";

		} else if(mouse.x < 0.70){ // Pink button
			str+="pink";
			body.style.backgroundColor = "#7A3880";

		} else { // Red button 
			str+="red";
			body.style.backgroundColor = "#802222";
		}
	}

	var test = document.getElementById("test")
	test.innerHTML = str;
}



function game_Over(){
	
}

</script>
</body>
</html>